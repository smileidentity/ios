name: Setup
description: Setup the Smile ID CI Environment
inputs:
  xcode:
    description: The version of Xcode to select
  install-mint:
    description: Whether to install mint
    default: true
runs:
  using: composite
  steps:
  - name: Select Xcode ${{ inputs.xcode }}
    if: ${{ inputs.xcode }}
    shell: bash
    run: |
      set -euo pipefail
      XCODE_APP="/Applications/Xcode_${{ inputs.xcode }}.app"
      if [ -d "$XCODE_APP" ]; then
        echo "Switching to $XCODE_APP"
        sudo xcode-select --switch "$XCODE_APP"
      else
        echo "Requested $XCODE_APP not found; keeping default Xcode."
        echo "Available Xcodes:"
        ls -1 /Applications | grep -E '^Xcode' || true
        echo "Active Xcode: $(xcode-select -p)"
        xcodebuild -version || true
      fi

  - name: Install Mint via Homebrew
    run: |
      if command -v mint >/dev/null; then
        echo "mint already installed"
      else
        echo "Installing mint via Homebrew"
        export HOMEBREW_NO_AUTO_UPDATE=1
        export HOMEBREW_NO_INSTALL_CLEANUP=1
        brew install mint
      fi
    if: ${{ inputs.install-mint == 'true' }}
    shell: bash

  - name: Configure Bundler path
    run: bundle config set path vendor/bundle
    shell: bash

  - name: Cache Ruby gems
    uses: actions/cache@v4
    with:
      path: vendor/bundle
      key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
      restore-keys: |
        ${{ runner.os }}-gems-

  - name: Install Ruby Gems
    run: bundle install --jobs 4 --retry 3
    shell: bash
